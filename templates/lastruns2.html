{% extends "base.html"%}
{% block content %}
<head>    <link rel="stylesheet" type="text/css" href="static/css/strava.css"> </head>

<script src="https://cdn.jsdelivr.net/npm/luxon@2.0.2/build/global/luxon.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.min.js"></script>

<div class = 'jumbotron'>
    <!-- <a id="authorise" href="{{url_for('lastruns2')}}" style="font-size: 24px; font-weight: bold ;">Get last runs</a> -->

    <div id="main-container">
        <!-- Text Section -->
        <div id="text-section">
            {% if latest_day and latest_time and mean_of_runs and current_time_delta is not none %}
                <h1 id="statistics-title">Run Commentary</h1>
                <h2 id="latest-day">Your most recent run was on {{ latest_day }}</h2>
                <h2 id="latest-time">Your most recent time was: {{ latest_time }}</h2>
                <h2 id="mean-of-runs">Your average time was: {{ mean_of_runs }}</h2>

                {% if current_time_delta < 0 %}
                    <h2 id="time-delta-slower">Your last run was {{ current_time_delta }} seconds slower than your average</h2>
                {% else %}
                    <h2 id="time-delta-faster">Your last run was {{ current_time_delta }} seconds faster than your average</h2>
                {% endif %}
            {% else %}
                <!-- Hidden by default if no data -->
                <div id="no-data-message">No data available yet.</div>
            {% endif %}
        </div>



        <!-- Query Box Section -->
        <div id="form-section">
            <h1 id="query-header">Query Settings</h1>
            <form method="POST" action="{{ url_for('lastruns2') }}" id="strava-form">
                <label for="dist_types">Select Distance:</label>
                <select id="dist_types" name="dist_types" required>
                    {% for key, value in dist_types.items() %}
                        <option value="{{ value }}">{{ key }}</option>
                    {% endfor %}
                </select>
                <input type="submit" value="Submit">
            </form>
        </div>
    </div>
</div>
<!-- i PUT THIS OUTSIDE OF THE JUMBOTRON -->

<div id="table-container">
    {% for table in tables %}
        <h3 id="table-title-{{ loop.index }}">{{ titles[loop.index0] }}</h3>
        {{ table | safe }}
    {% endfor %}
</div>

<!-- Reset the chart -->
<script>
    //Reset the chart
    function resetChart(chart) {
        chart.data.labels = []; // Clear x-axis labels
        chart.data.datasets.forEach(dataset => {
            dataset.data = []; // Clear dataset
        });
        chart.update(); // Update the chart to reflect changes
    }
    </script>



<div class="chart-container">
    <canvas id="StravaChart"></canvas>
</div>

<style>
  #StravaChart {
      max-width: 800px; /* Set a maximum width */
      height: 400px;    /* Set a fixed height */
      margin: 0 auto;   /* Center the chart horizontally */
  }

  /* Ensure parent container doesn't stretch unexpectedly */
  .chart-container {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
  }
</style>

<script>

// Ensure this script runs after the canvas element exists
document.addEventListener("DOMContentLoaded", () => {
        // JSON data from Flask, properly serialized
        const strava_chart_data = {{ strava_chart | safe }};

    // Extract labels and datasets from the JSON
    const labels = strava_chart_data.map(entry =>
        new Date(entry.Date).toLocaleDateString("en-US", { year: "numeric", month: "short", day: "numeric" })
    );
    const bestTimes = strava_chart_data.map(entry => entry.Best_Time); // Replace with your key
    const rollingMean = strava_chart_data.map(entry => entry.Rolling_Mean); // Replace with your key


        // Initialize the chart
        const ctx = document.getElementById("StravaChart").getContext("2d");
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Best Time',
                        data: bestTimes,
                        borderColor: '#36A2EB',
                        backgroundColor: '#9BD0F5',
                        fill: false,
                        borderWidth: 2
                    }
                    // ,
                    // {
                    //     label: 'Rolling Mean',
                    //     data: rollingMean,
                    //     borderColor: '#FF6384',
                    //     backgroundColor: '#FFB1C1',
                    //     fill: false,
                    //     borderWidth: 2
                    // }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 2, // Width to height ratio
                // plugins: {
                //     decimation: {
                //         enabled: true,
                //         algorithm: 'min-max',
                //         samples: 500
                //     }
                // }
                
                scales: {
                    x: {type: 'time', // Set the x-axis to handle time
                        time: {
                            parser: 'YYYY-MM-DD', // Parse the date format
                            unit: 'day', // Unit to display (day, week, month, etc.)
                            displayFormats: {
                                day: 'MMM DD' // Format displayed on the axis (e.g., 'Jan 01')
                                }
                            },
                        title: {
                            display: true,
                            text: 'Date'
                        },
                        ticks: {
                            autoSkip: true,
                            maxTicksLimit: 20
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Time (seconds)'
                        },
                        beginAtZero: false
                    }
                }
            }
        });
    });
</script>




{% endblock %}
