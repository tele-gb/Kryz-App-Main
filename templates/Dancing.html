{% extends "base.html"%}
{% block content %}

<head>    <link rel="stylesheet" type="text/css" href="static/css/ttracker.css"> </head>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


<div class = 'jumbotron'>
    <h1>Infectious Dancing Simulator</h1>

    <form id="simulation-form" method="POST">
        <label for="bpm">BPM:</label>
        <input type="number" id="bpm" name="bpm" value="120" min="60" max="240" required><br>

        <label for="population">Initial Population:</label>
        <input type="number" id="population" name="population" value="50" min="10" max="100000" required><br>

        <button type="submit">Run Simulation</button>
</div>

<div id="results">
    <h2>Simulation Results</h2>
    <table>
        <thead>
            <tr>
                <th>Tick</th>
                <th>Minutes</th>
                <th>Hours</th>
                <th>Days</th>
                <th>Total Alive</th>
                <th>Total Dead</th>
                <th>Infected Count</th>
            </tr>
        </thead>
        <tbody id="results-body">
            <!-- Rows are dynamically added here -->
        </tbody>
    </table>

   

</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('simulation-form');
    const resultsBody = document.getElementById('results-body');

    form.addEventListener('submit', function (event) {
        event.preventDefault(); // Prevent form from submitting normally

        // Clear the results table for a new simulation
        resultsBody.innerHTML = '';

        // Create or update the single row for the simulation
        let simulationRow = document.createElement('tr');
        resultsBody.appendChild(simulationRow);

        // Get form data
        const bpm = document.getElementById('bpm').value;
        const population = document.getElementById('population').value;

        // Define and initialize the EventSource
        const eventSource = new EventSource(`/run_simulation?bpm=${bpm}&population=${population}`);

        // Listen for messages from the server
        eventSource.onmessage = function (event) {
            console.log('Raw event data:', event.data);
            if (event.data === '{"message": "Simulation completed"}') {
                // Close the connection when simulation is complete
                eventSource.close();
                console.log('Simulation completed.');
            } else {
        // Parse the data and update the single row
            try {
                const data = JSON.parse(event.data);
                simulationRow.innerHTML = `
                    <td>${data.tick}</td>
                    <td>${data.minutes}</td>
                    <td>${data.hours}</td>
                    <td>${data.days}</td>

                    <td>${data.total_alive}</td>
                    <td>${data.total_dead}</td>
                    <td>${data.infected_count}</td>
                `;
            } catch (error) {
                console.error('Error parsing data:', error);
            }
    }
};


        // // Handle errors (optional)
        // eventSource.onerror = function (error) {
        //     console.error('Error with SSE:', error);
        //     eventSource.close();
        // };
    });
});
</script>

<canvas id="infectedChart" width="400" height="200"></canvas>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const ctx = document.getElementById('infectedChart').getContext('2d');
        const infectedChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [], // X-axis labels (time or ticks)
                datasets: [{
                    label: 'Infected',
                    data: [], // Y-axis data (number of infected)
                    borderColor: 'rgba(255, 99, 132, 1)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    fill: false,
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        type: 'linear',
                        position: 'bottom',
                    },
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    
        // Set up SSE to receive real-time data
        const eventSource = new EventSource('/run_simulation');
    
        eventSource.onmessage = function (event) {
            const data = JSON.parse(event.data);
    
            // Add the new data to the chart
            if (data.infected_count !== undefined) {
                const currentTime = data.tick; // Assuming tick is the time or iteration
                const infectedCount = data.infected_count;
    
                // Add new data to chart
                infectedChart.data.labels.push(currentTime);
                infectedChart.data.datasets[0].data.push(infectedCount);
    
                // Update the chart
                infectedChart.update();
            }
        };
    
        eventSource.onerror = function (error) {
            console.error('Error with SSE:', error);
            eventSource.close();
        };
    });
    </script>


{% endblock %}